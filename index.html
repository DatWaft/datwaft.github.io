<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Towers Game</title>
    <style>
      * { padding: 0; margin: 0; }
      canvas { background: #eee; display: block; margin: 0 auto; }
    </style>
</head>
<body>

<p><center>Towers - David Guevara 2019</center></p>
<hr>
<br>
<canvas id="canvas" width="800" height="600"></canvas>

<script>
// Context initialization.
  var canvas = document.getElementById("canvas");
  var ctx = canvas.getContext("2d");
// Loop declaration.
  var fps = 2;
  var loop = setInterval(function()
  {
    step();
    draw();
  }, 1000/fps);
// Event Listener.
  document.addEventListener("keypress", keypressHandler, false);
// Event Handler.
  var enter = false;
  function keypressHandler(e)
  {
    if(e.keyCode == 32 || e.keyCode == 13)
    {
      enter = true;
    }
  }
// Game variables.
  var width = 10;
  var currentSize = width/2;
  var blocks = [];
  var position = 0;
  var direction = '->';

  var lost = false;

  var height = 1;
// Display variables.
  var center = 
  {
    x: canvas.width / 2,
    y: canvas.height / 2
  };
  var cell = {l: 8, p: 2};
  var size = {w: width, h: 30};
  var rect =
  {
    x: center.x - ((cell.l + cell.p) * size.w)/2,
    y: center.y - ((cell.l + cell.p) * size.h)/2,
    w: (cell.l + cell.p) * size.w,
    h: (cell.l + cell.p) * size.h
  };
// Logic functions.
  function step()
  {
    if(enter)
    {
      var x1 = (blocks.length > 0 ? blocks[blocks.length - 1].x : 0);
      var x2 = (x1 + (blocks.length > 0 ? blocks[blocks.length - 1].x + 
        blocks[blocks.length - 1].s : width));
      var new_x1 = Math.max(x1, position);
      var new_x2 = Math.min(x2, position + currentSize);
      if(new_x1 > new_x2)
      {
        lost = true;
      }
      else
      {
        blocks.push({x: new_x1, s: new_x2 - new_x1});
        currentSize = new_x2 - new_x1;
      }
      enter = false;
      height += 1;
    }
    else
    {
      if(position == width - currentSize)
      {
        direction = '<-';
      }
      if(position == 0)
      {
        direction = '->'
      }
      if(direction == '<-')
      {
        position -= 1;
      }
      else
      {
        position += 1;
      }
    }
  }
// Drawing functions.
  function drawLost()
  {
    ctx.beginPath();
    ctx.rect(rect.x, rect.y, rect.w, rect.h);
    ctx.strokeStyle = "#000";
    ctx.fillStyle = "#fff";
    ctx.stroke();
    ctx.font = "30px Georgia";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "red";
    ctx.fillText("You lost! :c",rect.x+(rect.w/2),rect.y+(rect.h/2));
    ctx.closePath();
  }
  function drawBlock()
  {
    for(let i = position; i < position + currentSize; i++)
    {
      ctx.beginPath();
      ctx.rect(rect.x + i * (cell.l + cell.p) - cell.p, rect.y + (size.h - height) * 
        (cell.l + cell.p) - cell.p, cell.l, cell.l);
      ctx.fillStyle = "#000";
      ctx.fill();
      ctx.closePath();
    }
  }
  function drawBuilding()
  {
    for(let j = 0; j < blocks.length; j++)
    {
      for(let i = blocks[j].x; i < blocks[j].x + blocks[j].s; i++)
      {
        ctx.beginPath();
        ctx.rect(rect.x + i * (cell.l + cell.p) - cell.p, rect.y + (size.h - 
          height + (blocks.length - j)) * 
          (cell.l + cell.p) - cell.p, cell.l, cell.l);
        ctx.fillStyle = "#000";
        ctx.fill();
        ctx.closePath();
      }
    }
  }
  function draw()
  {
    ctx.clearRect(0,0, canvas.width, canvas.height);

    ctx.beginPath();
    ctx.rect(rect.x - 2, rect.y - 2, rect.w, rect.h);
    ctx.fillStyle = "#fff";
    ctx.fill();
    ctx.closePath();

    if(lost || currentSize == 0)
    {
      drawLost();
      clearInterval(loop);
    }
    else
    {
      drawBlock();
      drawBuilding();
    }
  }
</script>

</body>
</html>
