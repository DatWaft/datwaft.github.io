<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Towers Game</title>
    <style>
      * { padding: 0; margin: 0; }
      canvas {
        background: #eee;
        position:fixed;
        left:0;
        top:0;
        width:100%;
        height:100%;
      }
    </style>
</head>
<body>

<p><center>Towers - David Guevara 2019</center></p>
<hr>
<br>
<canvas id="canvas" width="300" height="400"></canvas>

<script>
// Context initialization.
  var canvas = document.getElementById("canvas");
  var ctx = canvas.getContext("2d");
// Loop declaration.
  function init()
  {
    step();
    draw();
    if(!lost && !(size.h == height))
      setTimeout(init, 1000/(height/2 + 2));
  };
// Event Listener.
  document.addEventListener("keypress", keypressHandler, false);
  document.addEventListener("touchstart", keypressHandler, false);
// Event Handler.
  var enter = false;
  function keypressHandler(e)
  {
    enter = true;
  }
// Game variables.
  var maximum_height = 20;
  var width = 10;
  var currentSize = width/2;
  var blocks = [];
  var position = 0;
  var direction = '->';

  var lost = false;

  var height = 1;
// Display variables.
  var center = 
  {
    x: canvas.width / 2,
    y: canvas.height / 2
  };
  var total_cell = canvas.height / (maximum_height + 2);
  var cell = {l: Math.round(total_cell * 8 / 10), p: Math.round(total_cell * 2 / 10)};
  var size = {w: width, h: 20};
  var rect =
  {
    x: center.x - ((cell.l + cell.p) * size.w)/2,
    y: center.y - ((cell.l + cell.p) * size.h)/2,
    w: (cell.l + cell.p) * size.w,
    h: (cell.l + cell.p) * size.h
  };
// Logic functions.
  function step()
  {
    if(enter)
    {
      var x = (blocks.length > 0 ? blocks[blocks.length - 1].x : 0);
      var s = (blocks.length > 0 ? blocks[blocks.length - 1].s : width);
      var new_pos = Math.max(x, position);
      var overlap = Math.max(0, Math.min(position + currentSize, x + s) -
        Math.max(position, x));
      if(overlap == 0)
      {
        lost = true;
      }
      else
      {
        blocks.push({x: new_pos, s: overlap});
        currentSize = overlap;
      }
      enter = false;
      height += 1;
    }
    else
    {
      if(position == width - currentSize)
      {
        direction = '<-';
      }
      if(position == 0)
      {
        direction = '->'
      }
      if(direction == '<-')
      {
        position -= 1;
      }
      else
      {
        position += 1;
      }
    }
  }
// Drawing functions.
  function drawLost()
  {
    ctx.beginPath();
    ctx.rect(rect.x, rect.y, rect.w, rect.h);
    ctx.strokeStyle = "#000";
    ctx.fillStyle = "#fff";
    ctx.stroke();
    ctx.font = "30px Georgia";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "red";
    ctx.fillText("You lost! :c",rect.x+(rect.w/2),rect.y+(rect.h/2));
    ctx.closePath();
  }
  function drawWon()
  {
    ctx.beginPath();
    ctx.rect(rect.x, rect.y, rect.w, rect.h);
    ctx.strokeStyle = "#000";
    ctx.fillStyle = "#fff";
    ctx.stroke();
    ctx.font = "30px Georgia";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "green";
    ctx.fillText("You won! c:",rect.x+(rect.w/2),rect.y+(rect.h/2));
    ctx.closePath();
  }
  function drawBlock()
  {
    for(let i = position; i < position + currentSize; i++)
    {
      ctx.beginPath();
      ctx.rect(rect.x + i * (cell.l + cell.p) - cell.p, rect.y + (size.h - height) * 
        (cell.l + cell.p) - cell.p, cell.l, cell.l);
      ctx.fillStyle = "#000";
      ctx.fill();
      ctx.closePath();
    }
  }
  function drawBuilding()
  {
    for(let j = 0; j < blocks.length; j++)
    {
      for(let i = blocks[j].x; i < blocks[j].x + blocks[j].s; i++)
      {
        ctx.beginPath();
        ctx.rect(rect.x + i * (cell.l + cell.p) - cell.p, rect.y + (size.h - 
          height + (blocks.length - j)) * 
          (cell.l + cell.p) - cell.p, cell.l, cell.l);
        ctx.fillStyle = "#000";
        ctx.fill();
        ctx.closePath();
      }
    }
  }
  function draw()
  {
    ctx.clearRect(0,0, canvas.width, canvas.height);

    ctx.beginPath();
    ctx.rect(rect.x - 2, rect.y - 2, rect.w, rect.h);
    ctx.fillStyle = "#fff";
    ctx.fill();
    ctx.closePath();

    if(lost || currentSize == 0)
    {
      drawLost();
    }
    else if(height == size.h)
    {
      drawWon();
    }
    else
    {
      drawBlock();
      drawBuilding();
    }
  }
  init();
</script>

</body>
</html>
