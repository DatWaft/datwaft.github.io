<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Infinite Towers Game</title>
  <style>

    * 
    { 
      padding: 0; 
      margin: 0; 
    }
    canvas 
    {
      background: #eee;
      position:fixed;
      left:0;
      top:0;
      width:100%;
      height:100%;
    }
  </style>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>
<body>

<audio id="music" autoplay="true" loop="true">
  <source src="music.ogg" type="audio/ogg">
  <source src="music.mp3" type="audio/mpeg">
  <source src="music.wav" type="audio/wav">
</audio>
<canvas id="canvas"></canvas>

<script>
  // Context initialization.
  var canvas = document.getElementById("canvas");
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;
  var ctx = canvas.getContext("2d");
  // Constants.
  const direction = 
  {
    LEFT: '<-',
    RIGHT: '->'
  };
  // Color generator.
  function getRandomColor() 
  {
    var letters = '0123456789ABCDEF';
    var color = '#';
    for (var i = 0; i < 6; i++) 
    {
      color += letters[Math.floor(Math.random() * 16)];
    }
    if (color == "FFFFFF")
    {
      color = "000000"
    }
    return color;
  }
  // Game flags.
  var game_has_begun = false;
  var game_needs_reset = false;
  var event_flag = false;
  // Game variables.
  const display = 
  {
    width: 10,
    height:	20
  };
  var current_size = Math.floor(display.width/2);
  var current_position = 0;
  var current_height = 0;
  var current_color = getRandomColor();
  var current_direction = direction.RIGHT;
  var building = [];
  // Game functions.
  function initialize()
  {
    current_size = Math.floor(display.width/2);
    current_position = 0;
    current_height = 0;
    current_color = getRandomColor();
    building = [];
    loop();
  }
  function loop()
  {
    step();
    render();
    if(game_has_begun && !game_needs_reset)
    {
      setTimeout(loop, 1000/((current_height)/2 + 2));
    }
  }
  function step()
  {
    if(event_flag)
    {
      var x = (building.length > 0 ? building[building.length - 1].x : 0);
      var s = (building.length > 0 ? building[building.length - 1].s : display.width);
      var new_pos = Math.max(x, current_position);
      var overlap = Math.max(0, Math.min(current_position + current_size, x + s) - Math.max(current_position, x));
      if(overlap == 0)
      {
        game_needs_reset = true;
      }
      else
      {
        building.push({x: new_pos, s: overlap, color: current_color});
        current_size = overlap;
        current_color = getRandomColor();
      }
      event_flag = false;
      current_height += 1;
    }
    else
    {
      if(current_position == display.width - current_size)
      {
        current_direction = direction.LEFT;
      }
      if(current_position == 0)
      {
        current_direction = direction.RIGHT;
      }
      if(current_direction == direction.LEFT)
      {
        current_position -= 1;
      }
      else
      {
        current_position += 1;
      }
    }
  }
  // Music initialization.
  function playMusic()
  {
    var music = document.getElementById('music');
    music.play();
    music.volume = 0.3;
  }
  // Event Listener.
  document.addEventListener("keypress", eventHandler, false);
  document.addEventListener("touchstart", eventHandler, false);
  // Event Handler.
  function eventHandler(e)
  {
    if(!game_has_begun)
    {
      playMusic();
      game_has_begun = true;
      initialize();
    }
    else if(game_needs_reset)
    {
      game_needs_reset = false;
      initialize();
    }
    else
    {
      event_flag = true;
    }
  }
  // Display constants.
  const center =
  {
    x: Math.round(canvas.width/2),
    y: Math.round(canvas.height/2)
  };
  const border_squares = 2;
  const text_squares = 2;
  const square_length = Math.round(canvas.height / (display.height + (border_squares + text_squares + 2) * 2));
  const square = 
  {
    side: Math.round(square_length * 8 / 10),
    padding: Math.round(square_length * 2 / 10)
  };
  const game_rect = 
  {
    x: Math.round(center.x - (square_length * display.width)/2),
    y: Math.round(center.y - (square_length * display.height)/2),
    width: Math.round(square_length * display.width),
    height: Math.round(square_length * display.height)
  };
  const display_rect = 
  {
    x: game_rect.x - border_squares * square_length,
    y: game_rect.y - border_squares * square_length,
    width: game_rect.width + border_squares * square_length * 2,
    height: game_rect.height + border_squares * square_length * 2
  };
  const score_rect = 
  {
    x: display_rect.x,
    y: display_rect.y + display_rect.height,
    width: display_rect.width,
    height: text_squares * square_length
  };
  const name_rect = 
  {
    x: display_rect.x,
    y: display_rect.y - text_squares * square_length,
    width: display_rect.width,
    height: text_squares * square_length
  };
  // Renderization functions.
  function renderBegin()
  {
    ctx.beginPath();
    ctx.font = "20px Georgia";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "blue";
    ctx.fillText("Press to begin", display_rect.x + (display_rect.width/2), display_rect.y + (display_rect.height/2));
    ctx.closePath();
  }
  function renderLost()
  {
    ctx.beginPath();
    ctx.font = "20px Georgia";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "red";
    ctx.fillText("You lost. Press to begin anew.", display_rect.x + (display_rect.width/2), display_rect.y + (display_rect.height/2));
    ctx.closePath();
  }
  function renderCurrent()
  {
    let height = (current_height > display.height ? display.height : current_height);
    for(let i = current_position; i < current_position + current_size; i++)
    {
      ctx.beginPath();
      ctx.rect(game_rect.x + i * square_length - square.padding, game_rect.y + (display.height - height) * square_length - square.padding, square.side, square.side);
      ctx.fillStyle = current_color;
      ctx.fill();
      ctx.closePath();
    }
  }
  function renderBuilding()
  {
    let height = (current_height > display.height ? display.height : current_height);
    for(let j = building.length - 1; j >= 0 && building.length - j <= height; j--)
    {
      for(let i = building[j].x; i < building[j].x + building[j].s; i++)
      {
        ctx.beginPath();
        ctx.rect(game_rect.x + i * square_length - square.padding, game_rect.y + (display.height - height + (building.length - j)) * square_length - square.padding, square.side, square.side);
        ctx.fillStyle = building[j].color;
        ctx.fill();
        ctx.closePath();
      }
    }
  }
  function render()
  {
    // Clear previous render.
    ctx.clearRect(0,0, canvas.width, canvas.height);
    // Display rectangle render.
    ctx.beginPath();
    ctx.rect(display_rect.x, display_rect.y, display_rect.width, display_rect.height);
    ctx.fillStyle = "#fff";
    ctx.strokeStyle = "#000";
    ctx.fill();
    ctx.stroke();
    ctx.closePath();
    // Render text.
    ctx.beginPath();
    ctx.font = "20px Georgia";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "black";
    ctx.fillText("Infinite Towers Game", name_rect.x + (name_rect.width/2), name_rect.y + (name_rect.height/2));
    ctx.fillText("Score:" + current_height, score_rect.x + (score_rect.width/2), score_rect.y + (score_rect.height/2));
    ctx.closePath();
    if(!game_has_begun)
    {
      renderBegin();
    }
    else if(game_needs_reset)
    {
      renderLost();
    }
    else
    {
      renderCurrent();
      renderBuilding();
    }
  }
  render();
</script>

</body>
</html>
